{"version":3,"file":"HistoryManager.mjs","sourceRoot":"","sources":["HistoryManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { processExecutor, getProcess, ProcessError, ProcessResult, ProcessCallback } from '../process';\nimport { PatchOperation } from '../state/Patch';\nimport { Pointer } from '../state/Pointer';\nimport Store from '../Store';\nimport WeakMap from '../../shim/WeakMap';\n\nexport interface HistoryOperation {\n\tid: string;\n\toperations: PatchOperation[];\n}\n\nexport interface HistoryData {\n\thistory: HistoryOperation[];\n\tredo: HistoryOperation[];\n}\n\nexport class HistoryManager {\n\tprivate _storeMap = new WeakMap();\n\n\tpublic collector(callback?: ProcessCallback): ProcessCallback {\n\t\treturn (error: ProcessError | null, result: ProcessResult): void => {\n\t\t\tconst { operations, undoOperations, id, store } = result;\n\t\t\tconst { history, undo } = this._storeMap.get(store) || {\n\t\t\t\thistory: [],\n\t\t\t\tundo: []\n\t\t\t};\n\t\t\thistory.push({ id, operations });\n\t\t\tundo.push({ id, operations: undoOperations });\n\t\t\tthis._storeMap.set(store, { history, undo, redo: [] });\n\t\t\tcallback && callback(error, result);\n\t\t};\n\t}\n\n\tpublic canUndo(store: Store): boolean {\n\t\tconst stacks = this._storeMap.get(store);\n\t\tif (stacks) {\n\t\t\tconst { history, undo } = stacks;\n\t\t\tif (undo.length && history.length) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic canRedo(store: Store): boolean {\n\t\tconst stacks = this._storeMap.get(store);\n\t\tif (stacks) {\n\t\t\tconst { redo } = stacks;\n\t\t\tif (redo.length) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic redo(store: Store) {\n\t\tconst stacks = this._storeMap.get(store);\n\t\tif (stacks) {\n\t\t\tconst { history, redo, undo } = stacks;\n\t\t\tif (redo.length) {\n\t\t\t\tconst { id, operations } = redo.pop();\n\t\t\t\tconst result = store.apply(operations);\n\t\t\t\thistory.push({ id, operations });\n\t\t\t\tundo.push({ id, operations: result });\n\t\t\t\tthis._storeMap.set(store, { history, undo, redo });\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic undo(store: Store) {\n\t\tconst stacks = this._storeMap.get(store);\n\t\tif (stacks) {\n\t\t\tconst { history, undo, redo } = stacks;\n\t\t\tif (undo.length && history.length) {\n\t\t\t\tconst { id, operations } = undo.pop();\n\t\t\t\thistory.pop();\n\t\t\t\tconst result = store.apply(operations);\n\t\t\t\tredo.push({ id, operations: result });\n\t\t\t\tthis._storeMap.set(store, { history, undo, redo });\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic deserialize(store: Store, data: HistoryData) {\n\t\tconst { history, redo } = data;\n\t\thistory.forEach(({ id, operations }: HistoryOperation) => {\n\t\t\toperations = operations.map((operation) => {\n\t\t\t\toperation.path = new Pointer(String(operation.path));\n\t\t\t\treturn operation;\n\t\t\t});\n\t\t\tlet callback;\n\t\t\tconst process = getProcess(id);\n\t\t\tif (process) {\n\t\t\t\tcallback = process[2];\n\t\t\t}\n\t\t\tprocessExecutor(id, [() => operations], store, callback, undefined)({});\n\t\t});\n\t\tconst stacks = this._storeMap.get(store);\n\t\tredo.forEach(({ id, operations }: HistoryOperation) => {\n\t\t\toperations = operations.map((operation) => {\n\t\t\t\toperation.path = new Pointer(String(operation.path));\n\t\t\t\treturn operation;\n\t\t\t});\n\t\t});\n\t\tstacks.redo = redo;\n\t}\n\n\tpublic serialize(store: Store): HistoryData {\n\t\tconst stacks = this._storeMap.get(store);\n\t\tif (stacks) {\n\t\t\treturn {\n\t\t\t\thistory: stacks.history,\n\t\t\t\tredo: stacks.redo\n\t\t\t};\n\t\t}\n\t\treturn { history: [], redo: [] };\n\t}\n}\n\nexport default HistoryManager;\n"]}