{"version":3,"file":"Scheduler.js","sourceRoot":"","sources":["../../../../src/core/Scheduler.ts"],"names":[],"mappings":"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","sourcesContent":["import { Handle } from './interfaces';\nimport { QueueItem, queueTask } from './queue';\n\nfunction getQueueHandle(item: QueueItem): Handle {\n\treturn {\n\t\tdestroy: function(this: Handle) {\n\t\t\tthis.destroy = function() {};\n\t\t\titem.isActive = false;\n\t\t\titem.callback = null;\n\t\t}\n\t};\n}\n\nexport interface KwArgs {\n\tdeferWhileProcessing?: boolean;\n\tqueueFunction?: (callback: (...args: any[]) => any) => Handle;\n}\n\nexport class Scheduler {\n\tprotected readonly _boundDispatch: () => void;\n\tprotected _deferred: QueueItem[] | null = null;\n\tprotected _isProcessing: boolean;\n\tprotected readonly _queue: QueueItem[];\n\tprotected _task: Handle | null = null;\n\n\t/**\n\t * Determines whether any callbacks registered during should be added to the current batch (`false`)\n\t * or deferred until the next batch (`true`, default).\n\t */\n\tdeferWhileProcessing: boolean | undefined;\n\n\t/**\n\t * Allows users to specify the function that should be used to schedule callbacks.\n\t * If no function is provided, then `queueTask` will be used.\n\t */\n\tqueueFunction: (callback: (...args: any[]) => any) => Handle;\n\n\tprotected _defer(callback: (...args: any[]) => void): Handle {\n\t\tconst item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\n\t\tif (!this._deferred) {\n\t\t\tthis._deferred = [];\n\t\t}\n\n\t\tthis._deferred.push(item);\n\n\t\treturn getQueueHandle(item);\n\t}\n\n\tprotected _dispatch(): void {\n\t\tthis._isProcessing = true;\n\t\tif (this._task) {\n\t\t\tthis._task.destroy();\n\t\t\tthis._task = null;\n\t\t}\n\n\t\tconst queue = this._queue;\n\t\tlet item: QueueItem | undefined;\n\n\t\twhile ((item = queue.shift())) {\n\t\t\tif (item.isActive && item.callback) {\n\t\t\t\titem.callback();\n\t\t\t}\n\t\t}\n\n\t\tthis._isProcessing = false;\n\n\t\tlet deferred: QueueItem[] | null = this._deferred;\n\t\tif (deferred && deferred.length) {\n\t\t\tthis._deferred = null;\n\n\t\t\tlet item: QueueItem | undefined;\n\t\t\twhile ((item = deferred.shift())) {\n\t\t\t\tthis._schedule(item);\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected _schedule(item: QueueItem): void {\n\t\tif (!this._task) {\n\t\t\tthis._task = this.queueFunction(this._boundDispatch);\n\t\t}\n\n\t\tthis._queue.push(item);\n\t}\n\n\tconstructor(kwArgs?: KwArgs) {\n\t\tthis.deferWhileProcessing = kwArgs && 'deferWhileProcessing' in kwArgs ? kwArgs.deferWhileProcessing : true;\n\t\tthis.queueFunction = kwArgs && kwArgs.queueFunction ? kwArgs.queueFunction : queueTask;\n\n\t\tthis._boundDispatch = this._dispatch.bind(this);\n\t\tthis._isProcessing = false;\n\t\tthis._queue = [];\n\t}\n\n\tschedule(callback: (...args: any[]) => void): Handle {\n\t\tif (this._isProcessing && this.deferWhileProcessing) {\n\t\t\treturn this._defer(callback);\n\t\t}\n\n\t\tconst item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\n\t\tthis._schedule(item);\n\n\t\treturn getQueueHandle(item);\n\t}\n}\n\nexport default Scheduler;\n"]}