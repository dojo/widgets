{"version":3,"file":"harness.js","sourceRoot":"","sources":["harness.ts"],"names":[],"mappings":";;;;;;;;;;;;IAAA,uDAAkD;IAClD,+CAA4C;IAG5C,sCAA8D;IAkD9D,uBAAuB,KAAU;QAChC,IAAI,qBAAqB,GAAG,KAAK,CAAC;QAClC,mBAAmB,MAAqB;YACvC,CAAC,MAAM,CAAC,QAAQ,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC,UAAC,KAAK;gBACrC,EAAE,CAAC,CAAC,WAAO,CAAC,KAAK,CAAC,IAAI,WAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;oBACrC,KAAa,CAAC,MAAM,GAAG,MAAM,CAAC;gBAChC,CAAC;YACF,CAAC,CAAC,CAAC;YACH,EAAE,CAAC,CAAC,WAAO,CAAC,MAAM,CAAC,IAAI,OAAO,MAAM,CAAC,0BAA0B,KAAK,UAAU,CAAC,CAAC,CAAC;gBAChF,qBAAqB,GAAG,IAAI,CAAC;gBAC7B,MAAM,CAAC,UAAU,wBAAQ,MAAM,CAAC,UAAU,EAAK,MAAM,CAAC,0BAA0B,CAAC,KAAK,CAAC,CAAE,CAAC;YAC3F,CAAC;QACF,CAAC;QACD,IAAM,KAAK,GAAG,YAAQ,CAAC,KAAK,EAAE,SAAS,EAAE,UAAC,IAAW,IAA4B,OAAA,WAAO,CAAC,IAAI,CAAC,IAAI,WAAO,CAAC,IAAI,CAAC,EAA9B,CAA8B,CAAC,CAAC;QACjH,MAAM,CAAC,EAAE,qBAAqB,uBAAA,EAAE,KAAK,OAAA,EAAE,CAAC;IACzC,CAAC;IAED,iBACC,UAA4C,EAC5C,gBAAyC;QAAzC,iCAAA,EAAA,qBAAyC;QAEzC,IAAI,WAAW,GAAG,IAAI,CAAC;QACvB,IAAI,KAAK,GAAG,UAAU,EAAE,CAAC;QACzB,IAAI,MAAkB,CAAC;QACvB,IAAM,WAAW,GAAwB,EAAE,CAAC;QACpC,IAAA,6BAAU,EAAE,yBAAQ,CAAW;QACvC,IAAM,iBAAiB,GAAG,KAAK,CAAC,iBAA4C,CAAC;QAC7E,EAAE,CAAC,CAAC,OAAO,iBAAiB,KAAK,UAAU,CAAC,CAAC,CAAC;YAC7C,MAAM,GAAG;gBAAkB,mCAAiB;gBAA/B;;gBAKb,CAAC;gBAJA,4BAAU,GAAV;oBACC,WAAW,GAAG,IAAI,CAAC;oBACnB,iBAAM,UAAU,WAAE,CAAC;gBACpB,CAAC;gBACF,cAAC;YAAD,CAAC,AALY,CAAc,iBAAiB,IAKzC,CAAC;YACJ,MAAM,CAAC,iBAAiB,CAAC,UAAU,CAAC,CAAC;YACrC,MAAM,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;YACjC,UAAU,EAAE,CAAC;QACd,CAAC;QAAC,IAAI,CAAC,CAAC;YACP,MAAM,IAAI,KAAK,CAAC,yCAAyC,CAAC,CAAC;QAC5D,CAAC;QAED,oBAAoB,KAAc;YACjC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QACzE,CAAC;QAED,sBAAsB,KAAsB,EAAE,UAA2B;YAA3B,2BAAA,EAAA,kBAA2B;YACxE,gBAAgB,CAAC,OAAO,CAAC,UAAC,EAAkC;oBAAhC,sBAAQ,EAAE,sBAAQ,EAAE,0BAAU;gBACzD,IAAM,KAAK,GAAG,iBAAM,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;gBACtC,KAAK,CAAC,OAAO,CAAC,UAAC,IAAS,EAAE,KAAa;oBACtC,IAAM,cAAc,GAAG,yBAAuB,QAAQ,UAAK,QAAQ,MAAG,CAAC;oBACvE,EAAE,CAAC,CAAC,IAAI,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,KAAK,SAAS,CAAC,CAAC,CAAC;wBACxE,IAAM,gBAAgB,GAAG,UAAU,CAAC,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;4BAC7D,CAAC,CAAC,cAAc;4BAChB,CAAC,CAAI,cAAc,YAAS,CAAC;wBAC9B,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,GAAG,UAAU,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,gBAAgB,CAAC;oBAC5E,CAAC;gBACF,CAAC,CAAC,CAAC;YACJ,CAAC,CAAC,CAAC;QACJ,CAAC;QAED;YACO,IAAA,iBAAuC,EAArC,0BAAU,EAAE,sBAAQ,CAAkB;YAC9C,MAAM,CAAC,iBAAiB,CAAC,UAAU,CAAC,CAAC;YACrC,MAAM,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;YACjC,EAAE,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;gBACjB,IAAM,MAAM,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;gBAC7B,IAAA,0BAAwD,EAAtD,gDAAqB,EAAE,gBAAK,CAA2B;gBAC/D,YAAY,CAAC,KAAK,CAAC,CAAC;gBACpB,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;gBACxB,EAAE,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC;oBACnB,IAAA,0DAAmC,CAA2B;oBACtE,YAAY,CAAC,4BAA4B,CAAC,CAAC;oBAC3C,WAAW,CAAC,IAAI,CAAC,4BAA4B,CAAC,CAAC;gBAChD,CAAC;gBACD,WAAW,GAAG,KAAK,CAAC;YACrB,CAAC;QACF,CAAC;QAED,iBAAiB,kBAAkC,EAAE,gBAAiC,EAAE,QAAiB;YACxG,IAAI,YAA6B,CAAC;YAClC,EAAE,CAAC,CAAC,gBAAgB,KAAK,SAAS,CAAC,CAAC,CAAC;gBACpC,UAAU,EAAE,CAAC;gBACb,YAAY,GAAG,UAAU,EAAE,CAAC;YAC7B,CAAC;YAAC,IAAI,CAAC,CAAC;gBACP,YAAY,GAAG,gBAAgB,EAAE,CAAC;YACnC,CAAC;YAEO,IAAA,gEAA2B,CAAyC;YAC5E,YAAY,CAAC,oBAAoB,EAAE,IAAI,CAAC,CAAC;YACzC,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACR,IAAA,iEAA4C,EAA3C,iBAAS,CAAmC;gBACnD,sBAAY,CAAC,SAAS,EAAE,oBAAoB,CAAC,CAAC;YAC/C,CAAC;YAAC,IAAI,CAAC,CAAC;gBACP,sBAAY,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;YAClD,CAAC;QACF,CAAC;QAED,MAAM,CAAC;YACN,MAAM,YAAC,kBAAkC,EAAE,gBAAiC;gBAC3E,MAAM,CAAC,OAAO,CAAC,kBAAkB,EAAE,gBAAgB,CAAC,CAAC;YACtD,CAAC;YACD,aAAa,YAAC,QAAgB,EAAE,kBAAkC,EAAE,gBAAiC;gBACpG,MAAM,CAAC,OAAO,CAAC,kBAAkB,EAAE,gBAAgB,EAAE,QAAQ,CAAC,CAAC;YAChE,CAAC;YACD,OAAO,EAAP,UAAQ,QAAgB,EAAE,gBAA6C;gBAAE,cAAc;qBAAd,UAAc,EAAd,qBAAc,EAAd,IAAc;oBAAd,6BAAc;;gBACtF,UAAU,EAAE,CAAC;gBACP,IAAA,iEAA4C,EAA3C,iBAAS,CAAmC;gBACnD,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;oBACf,IAAI,eAAe,SAAsB,CAAC;oBAC1C,EAAE,CAAC,CAAC,OAAO,gBAAgB,KAAK,QAAQ,CAAC,CAAC,CAAC;wBAC1C,eAAe,GAAI,SAAS,CAAC,UAAkB,CAAC,gBAAgB,CAAC,CAAC;oBACnE,CAAC;oBAAC,IAAI,CAAC,CAAC;wBACP,eAAe,GAAG,gBAAgB,CAAC,SAAS,CAAC,CAAC;oBAC/C,CAAC;oBACD,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC;wBACrB,MAAM,CAAC,eAAe,CAAC,KAAK,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;oBAC5C,CAAC;gBACF,CAAC;YACF,CAAC;YACD,SAAS,EAAT,UAAU,KAAc;gBACvB,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;YAC1B,CAAC;SACD,CAAC;IACH,CAAC;IA1GD,0BA0GC;IAED,kBAAe,OAAO,CAAC","sourcesContent":["import assertRender from './support/assertRender';\nimport { select } from './support/selector';\nimport { WNode, DNode, WidgetBaseInterface, Constructor, VNode } from '../widget-core/interfaces';\nimport { WidgetBase } from '../widget-core/WidgetBase';\nimport { decorate, isVNode, isWNode } from '../widget-core/d';\n\nexport interface CustomComparator {\n\tselector: string;\n\tproperty: string;\n\tcomparator: (value: any) => boolean;\n}\n\nexport interface FunctionalSelector {\n\t(node: VNode | WNode): undefined | Function;\n}\n\nexport interface DecoratorResult<T> {\n\thasDeferredProperties: boolean;\n\tnodes: T;\n}\n\nexport interface ExpectedRender {\n\t(): DNode | DNode[];\n}\n\nexport interface Expect {\n\t(expectedRenderFunc: ExpectedRender): void;\n\t(expectedRenderFunc: ExpectedRender, actualRenderFunc?: ExpectedRender): void;\n}\n\nexport interface ExpectPartial {\n\t(selector: string, expectedRenderFunc: ExpectedRender): void;\n\t(selector: string, expectedRenderFunc: ExpectedRender, actualRenderFunc?: ExpectedRender): void;\n}\n\nexport interface Trigger {\n\t(selector: string, functionSelector: FunctionalSelector, ...args: any[]): any;\n\t(selector: string, functionSelector: string, ...args: any[]): any;\n}\n\nexport interface GetRender {\n\t(index?: number): DNode | DNode[];\n}\n\nexport interface HarnessAPI {\n\texpect: Expect;\n\texpectPartial: ExpectPartial;\n\ttrigger: Trigger;\n\tgetRender: GetRender;\n}\n\nfunction decorateNodes(dNode: DNode[]): DecoratorResult<DNode[]>;\nfunction decorateNodes(dNode: DNode): DecoratorResult<DNode>;\nfunction decorateNodes(dNode: DNode | DNode[]): DecoratorResult<DNode | DNode[]>;\nfunction decorateNodes(dNode: any): DecoratorResult<DNode | DNode[]> {\n\tlet hasDeferredProperties = false;\n\tfunction addParent(parent: WNode | VNode): void {\n\t\t(parent.children || []).forEach((child) => {\n\t\t\tif (isVNode(child) || isWNode(child)) {\n\t\t\t\t(child as any).parent = parent;\n\t\t\t}\n\t\t});\n\t\tif (isVNode(parent) && typeof parent.deferredPropertiesCallback === 'function') {\n\t\t\thasDeferredProperties = true;\n\t\t\tparent.properties = { ...parent.properties, ...parent.deferredPropertiesCallback(false) };\n\t\t}\n\t}\n\tconst nodes = decorate(dNode, addParent, (node: DNode): node is WNode | VNode => isWNode(node) || isVNode(node));\n\treturn { hasDeferredProperties, nodes };\n}\n\nexport function harness(\n\trenderFunc: () => WNode<WidgetBaseInterface>,\n\tcustomComparator: CustomComparator[] = []\n): HarnessAPI {\n\tlet invalidated = true;\n\tlet wNode = renderFunc();\n\tlet widget: WidgetBase;\n\tconst renderStack: (DNode | DNode[])[] = [];\n\tconst { properties, children } = wNode;\n\tconst widgetConstructor = wNode.widgetConstructor as Constructor<WidgetBase>;\n\tif (typeof widgetConstructor === 'function') {\n\t\twidget = new class extends widgetConstructor {\n\t\t\tinvalidate() {\n\t\t\t\tinvalidated = true;\n\t\t\t\tsuper.invalidate();\n\t\t\t}\n\t\t}();\n\t\twidget.__setProperties__(properties);\n\t\twidget.__setChildren__(children);\n\t\t_tryRender();\n\t} else {\n\t\tthrow new Error('Harness does not support registry items');\n\t}\n\n\tfunction _getRender(count?: number): DNode | DNode[] {\n\t\treturn count ? renderStack[count] : renderStack[renderStack.length - 1];\n\t}\n\n\tfunction _runCompares(nodes: DNode | DNode[], isExpected: boolean = false) {\n\t\tcustomComparator.forEach(({ selector, property, comparator }) => {\n\t\t\tconst items = select(selector, nodes);\n\t\t\titems.forEach((item: any, index: number) => {\n\t\t\t\tconst comparatorName = `comparator(selector=${selector}, ${property})`;\n\t\t\t\tif (item && item.properties && item.properties[property] !== undefined) {\n\t\t\t\t\tconst comparatorResult = comparator(item.properties[property])\n\t\t\t\t\t\t? comparatorName\n\t\t\t\t\t\t: `${comparatorName} FAILED`;\n\t\t\t\t\titem.properties[property] = isExpected ? comparatorName : comparatorResult;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction _tryRender() {\n\t\tconst { properties, children } = renderFunc();\n\t\twidget.__setProperties__(properties);\n\t\twidget.__setChildren__(children);\n\t\tif (invalidated) {\n\t\t\tconst render = widget.__render__();\n\t\t\tconst { hasDeferredProperties, nodes } = decorateNodes(render);\n\t\t\t_runCompares(nodes);\n\t\t\trenderStack.push(nodes);\n\t\t\tif (hasDeferredProperties) {\n\t\t\t\tconst { nodes: afterDeferredPropertiesNodes } = decorateNodes(render);\n\t\t\t\t_runCompares(afterDeferredPropertiesNodes);\n\t\t\t\trenderStack.push(afterDeferredPropertiesNodes);\n\t\t\t}\n\t\t\tinvalidated = false;\n\t\t}\n\t}\n\n\tfunction _expect(expectedRenderFunc: ExpectedRender, actualRenderFunc?: ExpectedRender, selector?: string) {\n\t\tlet renderResult: DNode | DNode[];\n\t\tif (actualRenderFunc === undefined) {\n\t\t\t_tryRender();\n\t\t\trenderResult = _getRender();\n\t\t} else {\n\t\t\trenderResult = actualRenderFunc();\n\t\t}\n\n\t\tconst { nodes: expectedRenderResult } = decorateNodes(expectedRenderFunc());\n\t\t_runCompares(expectedRenderResult, true);\n\t\tif (selector) {\n\t\t\tconst [firstItem] = select(selector, renderResult);\n\t\t\tassertRender(firstItem, expectedRenderResult);\n\t\t} else {\n\t\t\tassertRender(renderResult, expectedRenderResult);\n\t\t}\n\t}\n\n\treturn {\n\t\texpect(expectedRenderFunc: ExpectedRender, actualRenderFunc?: ExpectedRender) {\n\t\t\treturn _expect(expectedRenderFunc, actualRenderFunc);\n\t\t},\n\t\texpectPartial(selector: string, expectedRenderFunc: ExpectedRender, actualRenderFunc?: ExpectedRender) {\n\t\t\treturn _expect(expectedRenderFunc, actualRenderFunc, selector);\n\t\t},\n\t\ttrigger(selector: string, functionSelector: string | FunctionalSelector, ...args: any[]): any {\n\t\t\t_tryRender();\n\t\t\tconst [firstItem] = select(selector, _getRender());\n\t\t\tif (firstItem) {\n\t\t\t\tlet triggerFunction: Function | undefined;\n\t\t\t\tif (typeof functionSelector === 'string') {\n\t\t\t\t\ttriggerFunction = (firstItem.properties as any)[functionSelector];\n\t\t\t\t} else {\n\t\t\t\t\ttriggerFunction = functionSelector(firstItem);\n\t\t\t\t}\n\t\t\t\tif (triggerFunction) {\n\t\t\t\t\treturn triggerFunction.apply(widget, args);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tgetRender(index?: number): DNode | DNode[] {\n\t\t\treturn _getRender(index);\n\t\t}\n\t};\n}\n\nexport default harness;\n"]}