{"version":3,"file":"RegistryHandler.js","sourceRoot":"","sources":["../../../../src/widget-core/RegistryHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { Map } from '../shim/Map';\nimport { Evented } from '../core/Evented';\nimport { EventObject } from '../core/interfaces';\nimport { Constructor, InjectorFactory, InjectorItem, RegistryLabel, WidgetBaseInterface } from './interfaces';\nimport { Registry, RegistryEventObject, RegistryItem } from './Registry';\n\nexport type RegistryHandlerEventMap = {\n\tinvalidate: EventObject<'invalidate'>;\n};\n\nexport class RegistryHandler extends Evented<RegistryHandlerEventMap> {\n\tprivate _registry = new Registry();\n\tprivate _registryWidgetLabelMap: Map<Registry, RegistryLabel[]> = new Map();\n\tprivate _registryInjectorLabelMap: Map<Registry, RegistryLabel[]> = new Map();\n\tprotected baseRegistry?: Registry;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.own(this._registry);\n\t\tconst destroy = () => {\n\t\t\tif (this.baseRegistry) {\n\t\t\t\tthis._registryWidgetLabelMap.delete(this.baseRegistry);\n\t\t\t\tthis._registryInjectorLabelMap.delete(this.baseRegistry);\n\t\t\t\tthis.baseRegistry = undefined;\n\t\t\t}\n\t\t};\n\t\tthis.own({ destroy });\n\t}\n\n\tpublic set base(baseRegistry: Registry) {\n\t\tif (this.baseRegistry) {\n\t\t\tthis._registryWidgetLabelMap.delete(this.baseRegistry);\n\t\t\tthis._registryInjectorLabelMap.delete(this.baseRegistry);\n\t\t}\n\t\tthis.baseRegistry = baseRegistry;\n\t}\n\n\tpublic define(label: RegistryLabel, widget: RegistryItem): void {\n\t\tthis._registry.define(label, widget);\n\t}\n\n\tpublic defineInjector(label: RegistryLabel, injector: InjectorFactory): void {\n\t\tthis._registry.defineInjector(label, injector);\n\t}\n\n\tpublic has(label: RegistryLabel): boolean {\n\t\treturn this._registry.has(label) || Boolean(this.baseRegistry && this.baseRegistry.has(label));\n\t}\n\n\tpublic hasInjector(label: RegistryLabel): boolean {\n\t\treturn this._registry.hasInjector(label) || Boolean(this.baseRegistry && this.baseRegistry.hasInjector(label));\n\t}\n\n\tpublic get<T extends WidgetBaseInterface = WidgetBaseInterface>(\n\t\tlabel: RegistryLabel,\n\t\tglobalPrecedence: boolean = false\n\t): Constructor<T> | null {\n\t\treturn this._get(label, globalPrecedence, 'get', this._registryWidgetLabelMap);\n\t}\n\n\tpublic getInjector<T>(label: RegistryLabel, globalPrecedence: boolean = false): InjectorItem<T> | null {\n\t\treturn this._get(label, globalPrecedence, 'getInjector', this._registryInjectorLabelMap);\n\t}\n\n\tprivate _get(\n\t\tlabel: RegistryLabel,\n\t\tglobalPrecedence: boolean,\n\t\tgetFunctionName: 'getInjector' | 'get',\n\t\tlabelMap: Map<Registry, RegistryLabel[]>\n\t): any {\n\t\tconst registries = globalPrecedence ? [this.baseRegistry, this._registry] : [this._registry, this.baseRegistry];\n\t\tfor (let i = 0; i < registries.length; i++) {\n\t\t\tconst registry: any = registries[i];\n\t\t\tif (!registry) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst item = registry[getFunctionName](label);\n\t\t\tconst registeredLabels = labelMap.get(registry) || [];\n\t\t\tif (item) {\n\t\t\t\treturn item;\n\t\t\t} else if (registeredLabels.indexOf(label) === -1) {\n\t\t\t\tconst handle = registry.on(label, (event: RegistryEventObject) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\tevent.action === 'loaded' &&\n\t\t\t\t\t\t(this as any)[getFunctionName](label, globalPrecedence) === event.item\n\t\t\t\t\t) {\n\t\t\t\t\t\tthis.emit({ type: 'invalidate' });\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tthis.own(handle);\n\t\t\t\tlabelMap.set(registry, [...registeredLabels, label]);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n}\n\nexport default RegistryHandler;\n"]}