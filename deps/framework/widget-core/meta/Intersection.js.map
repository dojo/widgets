{"version":3,"file":"Intersection.js","sourceRoot":"","sources":["Intersection.ts"],"names":[],"mappings":"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","sourcesContent":["import global from '../../shim/global';\nimport WeakMap from '../../shim/WeakMap';\nimport Map from '../../shim/Map';\nimport { createHandle } from '../../core/lang';\nimport { Base } from './Base';\n\ninterface ExtendedIntersectionObserverEntry extends IntersectionObserverEntry {\n\treadonly isIntersecting: boolean;\n}\n\ninterface IntersectionDetail extends IntersectionGetOptions {\n\tentries: WeakMap<Element, IntersectionResult>;\n\tobserver: IntersectionObserver;\n}\n\nexport interface IntersectionGetOptions {\n\troot?: string;\n\trootMargin?: string;\n\tthreshold?: number[];\n}\n\nexport interface IntersectionResult {\n\tintersectionRatio: number;\n\tisIntersecting: boolean;\n}\n\nconst defaultIntersection: IntersectionResult = Object.freeze({\n\tintersectionRatio: 0,\n\tisIntersecting: false\n});\n\nexport class Intersection extends Base {\n\tprivate readonly _details = new Map<string, IntersectionDetail>();\n\n\t/**\n\t * Return an `InteractionResult` for the requested key and options.\n\t *\n\t * @param key The key to return the intersection meta for\n\t * @param options The options for the request\n\t */\n\tpublic get(key: string | number, options: IntersectionGetOptions = {}): IntersectionResult {\n\t\tlet rootNode: HTMLElement | undefined;\n\t\tif (options.root) {\n\t\t\trootNode = this.getNode(options.root) as HTMLElement;\n\t\t\tif (!rootNode) {\n\t\t\t\treturn defaultIntersection;\n\t\t\t}\n\t\t}\n\t\tconst node = this.getNode(key);\n\t\tif (!node) {\n\t\t\treturn defaultIntersection;\n\t\t}\n\n\t\tlet details = this._getDetails(options) || this._createDetails(options, rootNode);\n\t\tif (!details.entries.get(node)) {\n\t\t\tdetails.entries.set(node, defaultIntersection);\n\t\t\tdetails.observer.observe(node);\n\t\t}\n\n\t\treturn details.entries.get(node) || defaultIntersection;\n\t}\n\n\t/**\n\t * Returns true if the node for the key has intersection details\n\t *\n\t * @param key The key to return the intersection meta for\n\t * @param options The options for the request\n\t */\n\tpublic has(key: string | number, options?: IntersectionGetOptions): boolean {\n\t\tconst node = this.getNode(key);\n\t\tconst details = this._getDetails(options);\n\t\treturn Boolean(details && node && details.entries.has(node));\n\t}\n\n\tprivate _createDetails(options: IntersectionGetOptions, rootNode?: HTMLElement): IntersectionDetail {\n\t\tconst entries = new WeakMap<HTMLElement, ExtendedIntersectionObserverEntry>();\n\t\tconst observer = new global.IntersectionObserver(this._onIntersect(entries), { ...options, root: rootNode });\n\t\tconst details = { observer, entries, ...options };\n\n\t\tthis._details.set(JSON.stringify(options), details);\n\t\tthis.own(createHandle(() => observer.disconnect()));\n\t\treturn details;\n\t}\n\n\tprivate _getDetails(options: IntersectionGetOptions = {}): IntersectionDetail | undefined {\n\t\treturn this._details.get(JSON.stringify(options));\n\t}\n\n\tprivate _onIntersect = (detailEntries: WeakMap<Element, IntersectionResult>) => {\n\t\treturn (entries: ExtendedIntersectionObserverEntry[]) => {\n\t\t\tfor (const { intersectionRatio, isIntersecting, target } of entries) {\n\t\t\t\tdetailEntries.set(target, { intersectionRatio, isIntersecting });\n\t\t\t}\n\t\t\tthis.invalidate();\n\t\t};\n\t};\n}\n\nexport default Intersection;\n"]}