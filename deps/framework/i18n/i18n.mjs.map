{"version":3,"file":"i18n.mjs","sourceRoot":"","sources":["../../../../src/i18n/i18n.ts"],"names":[],"mappings":"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","sourcesContent":["/* tslint:disable:interface-name */\nimport global from '../shim/global';\nimport Map from '../shim/Map';\nimport Evented from '../core/Evented';\nimport has from '../core/has';\nimport uuid from '../core/uuid';\nimport { Handle } from '../core/interfaces';\nimport { useDefault } from '../core/load/util';\nimport * as Globalize from 'globalize/dist/globalize/message';\nimport { isLoaded } from './cldr/load';\nimport { generateLocales, normalizeLocale } from './util/main';\n\n/**\n * A default bundle used as basis for loading locale-specific bundles.\n */\nexport interface Bundle<T extends Messages> {\n\t/**\n\t * A unique identifier for the bundle that will be generated automatically when it is registered.\n\t */\n\treadonly id?: string;\n\n\t/**\n\t * A list of supported locales. Any included locale MUST have an associated bundle.\n\t */\n\treadonly locales?: LocaleLoaders<T>;\n\n\t/**\n\t * The map of default messages that will be used when locale-specific messages are unavailable.\n\t * Note that any message key used in the i18n system MUST have a default specified here.\n\t */\n\treadonly messages: T;\n}\n\n/**\n * Options object passed to message formatters and used for token replacement.\n */\nexport interface FormatOptions {\n\t[key: string]: any;\n}\n\nexport interface I18n<T extends Messages> {\n\t(bundle: Bundle<T>, locale?: string): Promise<T>;\n\n\t/**\n\t * The current namespace as set via `switchLocale`. Defaults to `systemLocale`.\n\t */\n\treadonly locale: string;\n}\n\n/**\n * A map of locales to functions responsible for loading their respective translations.\n */\nexport interface LocaleLoaders<T extends Messages> {\n\t[locale: string]: () => LocaleTranslations<T> | Promise<LocaleTranslations<T>>;\n}\n\n/**\n * An object of locale-specific translations.\n */\nexport type LocaleTranslations<T extends Messages> = Partial<T> | { default?: Partial<T> };\n\n/**\n * Describes a compiled ICU message formatter function.\n */\nexport interface MessageFormatter {\n\t(options?: FormatOptions): string;\n}\n\n/**\n * An object of keys to locale messages.\n */\nexport interface Messages {\n\t[key: string]: string;\n}\n\nconst TOKEN_PATTERN = /\\{([a-z0-9_]+)\\}/gi;\nconst bundleMap = new Map<string, Map<string, Messages>>();\nconst formatterMap = new Map<string, MessageFormatter>();\nconst localeProducer = new Evented();\nlet rootLocale: string;\n\n/**\n * Return the bundle's unique identifier, creating one if it does not already exist.\n *\n * @param bundle A message bundle\n * @return The bundle's unique identifier\n */\nfunction getBundleId<T extends Messages>(bundle: Bundle<T>): string {\n\tif (bundle.id) {\n\t\treturn bundle.id;\n\t}\n\n\tconst id = uuid();\n\tObject.defineProperty(bundle, 'id', {\n\t\tvalue: id\n\t});\n\treturn id;\n}\n\n/**\n * @private\n * Return a function that formats an ICU-style message, and takes an optional value for token replacement.\n *\n * Usage:\n * const formatter = getMessageFormatter(bundle, 'guestInfo', 'fr');\n * const message = formatter({\n *   host: 'Miles',\n *   gender: 'male',\n *   guest: 'Oscar',\n *   guestCount: '15'\n * });\n *\n * @param id\n * The message's bundle id.\n *\n * @param key\n * The message's key.\n *\n * @param locale\n * An optional locale for the formatter. If no locale is supplied, or if the locale is not supported, the\n * default locale is used.\n *\n * @return\n * The message formatter.\n */\nfunction getIcuMessageFormatter(id: string, key: string, locale?: string): MessageFormatter {\n\tlocale = normalizeLocale(locale || getRootLocale());\n\tconst formatterKey = `${locale}:${id}:${key}`;\n\tlet formatter = formatterMap.get(formatterKey);\n\n\tif (formatter) {\n\t\treturn formatter;\n\t}\n\n\tconst globalize = locale !== getRootLocale() ? new Globalize(normalizeLocale(locale)) : Globalize;\n\tformatter = globalize.messageFormatter(`${id}/${key}`);\n\n\tconst cached = bundleMap.get(id);\n\tif (cached && cached.get(locale)) {\n\t\tformatterMap.set(formatterKey, formatter);\n\t}\n\n\treturn formatter;\n}\n\n/**\n * @private\n * Load the specified locale-specific bundles, mapping the default exports to simple `Messages` objects.\n */\nfunction loadLocaleBundles<T extends Messages>(locales: LocaleLoaders<T>, supported: string[]): Promise<T[]> {\n\treturn Promise.all(supported.map((locale) => locales[locale]())).then((bundles) => {\n\t\treturn bundles.map((bundle) => useDefault(bundle));\n\t});\n}\n\n/**\n * @private\n * Return the root locale. Defaults to the system locale.\n */\nfunction getRootLocale(): string {\n\treturn rootLocale || systemLocale;\n}\n\n/**\n * @private\n * Retrieve a list of supported locales that can provide messages for the specified locale.\n *\n * @param locale\n * The target locale.\n *\n * @param supported\n * The locales that are supported by the bundle.\n *\n * @return\n * A list of supported locales that match the target locale.\n */\nfunction getSupportedLocales(locale: string, supported: string[] = []): string[] {\n\treturn generateLocales(locale).filter((locale: string) => supported.indexOf(locale) > -1);\n}\n\n/**\n * @private\n * Inject messages for the specified locale into the i18n system.\n *\n * @param id\n * The bundle's unique identifier\n *\n * @param messages\n * The messages to inject\n *\n * @param locale\n * An optional locale. If not specified, then it is assumed that the messages are the defaults for the given\n * bundle path.\n */\nfunction loadMessages<T extends Messages>(id: string, messages: T, locale: string = 'root') {\n\tlet cached = bundleMap.get(id);\n\n\tif (!cached) {\n\t\tcached = new Map<string, Messages>();\n\t\tbundleMap.set(id, cached);\n\t}\n\n\tcached.set(locale, messages);\n\tGlobalize.loadMessages({\n\t\t[locale]: {\n\t\t\t[id]: messages\n\t\t}\n\t});\n}\n\n/**\n * Return a formatted message.\n *\n * If both the \"supplemental/likelySubtags\" and \"supplemental/plurals-type-cardinal\" CLDR data have been loaded, then\n * the ICU message format is supported. Otherwise, a simple token-replacement mechanism is used.\n *\n * Usage:\n * formatMessage(bundle, 'guestInfo', {\n *   host: 'Bill',\n *   guest: 'John'\n * }, 'fr');\n *\n * @param bundle\n * The bundle containing the target message.\n *\n * @param key\n * The message's key.\n *\n * @param options\n * An optional value used by the formatter to replace tokens with values.\n *\n * @param locale\n * An optional locale for the formatter. If no locale is supplied, or if the locale is not supported, the\n * default locale is used.\n *\n * @return\n * The formatted message.\n */\nexport function formatMessage<T extends Messages>(\n\tbundle: Bundle<T>,\n\tkey: string,\n\toptions?: FormatOptions,\n\tlocale?: string\n): string {\n\treturn getMessageFormatter(bundle, key, locale)(options);\n}\n\n/**\n * Return the cached messages for the specified bundle and locale. If messages have not been previously loaded for the\n * specified locale, no value will be returned.\n *\n * @param bundle\n * The default bundle that is used to determine where the locale-specific bundles are located.\n *\n * @param locale\n * The locale of the desired messages.\n *\n * @return The cached messages object, if it exists.\n */\nexport function getCachedMessages<T extends Messages>(bundle: Bundle<T>, locale: string): T | void {\n\tconst { id = getBundleId(bundle), locales, messages } = bundle;\n\tconst cached = bundleMap.get(id);\n\n\tif (!cached) {\n\t\tloadMessages(id, messages);\n\t} else {\n\t\tconst localeMessages = cached.get(locale);\n\t\tif (localeMessages) {\n\t\t\treturn localeMessages as T;\n\t\t}\n\t}\n\n\tconst supportedLocales = getSupportedLocales(locale, locales && Object.keys(locales));\n\tif (!supportedLocales.length) {\n\t\treturn messages;\n\t}\n\n\tif (cached) {\n\t\treturn cached.get(supportedLocales[supportedLocales.length - 1]) as T;\n\t}\n}\n\n/**\n * Return a function that formats a specific message, and takes an optional value for token replacement.\n *\n * If both the \"supplemental/likelySubtags\" and \"supplemental/plurals-type-cardinal\" CLDR data have been loaded, then\n * the returned function will have ICU message format support. Otherwise, the returned function will perform a simple\n * token replacement on the message string.\n *\n * Usage:\n * const formatter = getMessageFormatter(bundle, 'guestInfo', 'fr');\n * const message = formatter({\n *   host: 'Miles',\n *   gender: 'male',\n *   guest: 'Oscar',\n *   guestCount: '15'\n * });\n *\n * @param bundle\n * The bundle containing the target message.\n *\n * @param key\n * The message's key.\n *\n * @param locale\n * An optional locale for the formatter. If no locale is supplied, or if the locale is not supported, the\n * default locale is used.\n *\n * @return\n * The message formatter.\n */\nexport function getMessageFormatter<T extends Messages>(\n\tbundle: Bundle<T>,\n\tkey: string,\n\tlocale?: string\n): MessageFormatter {\n\tconst { id = getBundleId(bundle) } = bundle;\n\n\tif (isLoaded('supplemental', 'likelySubtags') && isLoaded('supplemental', 'plurals-type-cardinal')) {\n\t\treturn getIcuMessageFormatter(id, key, locale);\n\t}\n\n\tconst cached = bundleMap.get(id);\n\tconst messages = cached ? cached.get(locale || getRootLocale()) || cached.get('root') : null;\n\n\tif (!messages) {\n\t\tthrow new Error(`The bundle has not been registered.`);\n\t}\n\n\treturn function(options: FormatOptions = Object.create(null)) {\n\t\treturn messages[key].replace(TOKEN_PATTERN, (token: string, property: string) => {\n\t\t\tconst value = options[property];\n\n\t\t\tif (typeof value === 'undefined') {\n\t\t\t\tthrow new Error(`Missing property ${property}`);\n\t\t\t}\n\n\t\t\treturn value;\n\t\t});\n\t};\n}\n\n/**\n * Load locale-specific messages for the specified bundle and locale.\n *\n * @param bundle\n * The default bundle that is used to determine where the locale-specific bundles are located.\n *\n * @param locale\n * An optional locale. If no locale is provided, then the current locale is assumed.\n *\n * @return A promise to the locale-specific messages.\n */\nasync function i18n<T extends Messages>(bundle: Bundle<T>, locale?: string): Promise<T> {\n\tconst currentLocale = locale ? normalizeLocale(locale) : getRootLocale();\n\tconst cachedMessages = getCachedMessages(bundle, currentLocale);\n\n\tif (cachedMessages) {\n\t\treturn cachedMessages;\n\t}\n\n\tconst locales = bundle.locales as LocaleLoaders<T>;\n\tconst supportedLocales = getSupportedLocales(currentLocale, Object.keys(locales));\n\tconst bundles = await loadLocaleBundles<T>(locales, supportedLocales);\n\treturn bundles.reduce((previous: any, partial: any): T => {\n\t\tconst localeMessages: T = { ...previous, ...partial };\n\t\tloadMessages(getBundleId(bundle), <T>Object.freeze(localeMessages), currentLocale);\n\t\treturn localeMessages;\n\t}, bundle.messages);\n}\n\nObject.defineProperty(i18n, 'locale', {\n\tget: getRootLocale\n});\n\nexport default i18n as I18n<Messages>;\n\n/**\n * Invalidate the cache for a particular bundle, or invalidate the entire cache. Note that cached messages for all\n * locales for a given bundle will be cleared.\n *\n * @param bundle\n * An optional bundle to invalidate. If no bundle is provided, then the cache is cleared for all bundles.\n */\nexport function invalidate<T extends Messages>(bundle?: Bundle<T>) {\n\tif (bundle) {\n\t\tbundle.id && bundleMap.delete(bundle.id);\n\t} else {\n\t\tbundleMap.clear();\n\t}\n}\n\n/**\n * Register an observer to be notified when the root locale changes.\n *\n * @param callback\n * A callback function which will receive the updated locale string on updates.\n *\n * @return\n * A handle object that can be used to unsubscribe from updates.\n */\nexport const observeLocale = function(callback: (locale: string) => {}): Handle {\n\treturn localeProducer.on('change', (event: any) => {\n\t\tcallback(event.target);\n\t});\n};\n\n/**\n * Pre-load locale-specific messages into the i18n system.\n *\n * @param bundle\n * The default bundle that is used to merge locale-specific messages with the default messages.\n *\n * @param messages\n * The messages to cache.\n *\n * @param locale\n * The locale for the messages\n */\nexport function setLocaleMessages<T extends Messages>(\n\tbundle: Bundle<T>,\n\tlocaleMessages: Partial<T>,\n\tlocale: string\n): void {\n\tconst messages: T = { ...(bundle.messages as any), ...(localeMessages as any) };\n\tloadMessages(getBundleId(bundle), <T>Object.freeze(messages), locale);\n}\n\n/**\n * Change the root locale, and notify any registered observers.\n *\n * @param locale\n * The new locale.\n */\nexport function switchLocale(locale: string): void {\n\tconst previous = rootLocale;\n\trootLocale = locale ? normalizeLocale(locale) : '';\n\n\tif (previous !== rootLocale) {\n\t\tif (isLoaded('supplemental', 'likelySubtags')) {\n\t\t\tGlobalize.load({\n\t\t\t\tmain: {\n\t\t\t\t\t[rootLocale]: {}\n\t\t\t\t}\n\t\t\t});\n\t\t\tGlobalize.locale(rootLocale);\n\t\t}\n\n\t\tlocaleProducer.emit({ type: 'change', target: rootLocale });\n\t}\n}\n\n/**\n * The default environment locale.\n *\n * It should be noted that while the system locale will be normalized to a single\n * format when loading message bundles, this value represents the unaltered\n * locale returned directly by the environment.\n */\nexport const systemLocale: string = (function() {\n\tlet systemLocale = 'en';\n\tif (has('host-browser')) {\n\t\tconst navigator = global.navigator;\n\t\tsystemLocale = navigator.language || navigator.userLanguage;\n\t} else if (has('host-node')) {\n\t\tsystemLocale = process.env.LANG || systemLocale;\n\t}\n\treturn normalizeLocale(systemLocale);\n})();\n"]}