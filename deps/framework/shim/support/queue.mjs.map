{"version":3,"file":"queue.mjs","sourceRoot":"","sources":["queue.ts"],"names":[],"mappings":"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","sourcesContent":["import global from '../global';\nimport has from './has';\nimport { Handle } from '../interfaces';\n\nfunction executeTask(item: QueueItem | undefined): void {\n\tif (item && item.isActive && item.callback) {\n\t\titem.callback();\n\t}\n}\n\nfunction getQueueHandle(item: QueueItem, destructor?: (...args: any[]) => any): Handle {\n\treturn {\n\t\tdestroy: function(this: Handle) {\n\t\t\tthis.destroy = function() {};\n\t\t\titem.isActive = false;\n\t\t\titem.callback = null;\n\n\t\t\tif (destructor) {\n\t\t\t\tdestructor();\n\t\t\t}\n\t\t}\n\t};\n}\n\ninterface PostMessageEvent extends Event {\n\tsource: any;\n\tdata: string;\n}\n\nexport interface QueueItem {\n\tisActive: boolean;\n\tcallback: null | ((...args: any[]) => any);\n}\n\nlet checkMicroTaskQueue: () => void;\nlet microTasks: QueueItem[];\n\n/**\n * Schedules a callback to the macrotask queue.\n *\n * @param callback the function to be queued and later executed.\n * @returns An object with a `destroy` method that, when called, prevents the registered callback from executing.\n */\nexport const queueTask = (function() {\n\tlet destructor: (...args: any[]) => any;\n\tlet enqueue: (item: QueueItem) => void;\n\n\t// Since the IE implementation of `setImmediate` is not flawless, we will test for `postMessage` first.\n\tif (has('postmessage')) {\n\t\tconst queue: QueueItem[] = [];\n\n\t\tglobal.addEventListener('message', function(event: PostMessageEvent): void {\n\t\t\t// Confirm that the event was triggered by the current window and by this particular implementation.\n\t\t\tif (event.source === global && event.data === 'dojo-queue-message') {\n\t\t\t\tevent.stopPropagation();\n\n\t\t\t\tif (queue.length) {\n\t\t\t\t\texecuteTask(queue.shift());\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tenqueue = function(item: QueueItem): void {\n\t\t\tqueue.push(item);\n\t\t\tglobal.postMessage('dojo-queue-message', '*');\n\t\t};\n\t} else if (has('setimmediate')) {\n\t\tdestructor = global.clearImmediate;\n\t\tenqueue = function(item: QueueItem): any {\n\t\t\treturn setImmediate(executeTask.bind(null, item));\n\t\t};\n\t} else {\n\t\tdestructor = global.clearTimeout;\n\t\tenqueue = function(item: QueueItem): any {\n\t\t\treturn setTimeout(executeTask.bind(null, item), 0);\n\t\t};\n\t}\n\n\tfunction queueTask(callback: (...args: any[]) => any): Handle {\n\t\tconst item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\t\tconst id: any = enqueue(item);\n\n\t\treturn getQueueHandle(\n\t\t\titem,\n\t\t\tdestructor &&\n\t\t\t\tfunction() {\n\t\t\t\t\tdestructor(id);\n\t\t\t\t}\n\t\t);\n\t}\n\n\t// TODO: Use aspect.before when it is available.\n\treturn has('microtasks')\n\t\t? queueTask\n\t\t: function(callback: (...args: any[]) => any): Handle {\n\t\t\t\tcheckMicroTaskQueue();\n\t\t\t\treturn queueTask(callback);\n\t\t\t};\n})();\n\n// When no mechanism for registering microtasks is exposed by the environment, microtasks will\n// be queued and then executed in a single macrotask before the other macrotasks are executed.\nif (!has('microtasks')) {\n\tlet isMicroTaskQueued = false;\n\n\tmicroTasks = [];\n\tcheckMicroTaskQueue = function(): void {\n\t\tif (!isMicroTaskQueued) {\n\t\t\tisMicroTaskQueued = true;\n\t\t\tqueueTask(function() {\n\t\t\t\tisMicroTaskQueued = false;\n\n\t\t\t\tif (microTasks.length) {\n\t\t\t\t\tlet item: QueueItem | undefined;\n\t\t\t\t\twhile ((item = microTasks.shift())) {\n\t\t\t\t\t\texecuteTask(item);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Schedules an animation task with `window.requestAnimationFrame` if it exists, or with `queueTask` otherwise.\n *\n * Since requestAnimationFrame's behavior does not match that expected from `queueTask`, it is not used there.\n * However, at times it makes more sense to delegate to requestAnimationFrame; hence the following method.\n *\n * @param callback the function to be queued and later executed.\n * @returns An object with a `destroy` method that, when called, prevents the registered callback from executing.\n */\nexport const queueAnimationTask = (function() {\n\tif (!has('raf')) {\n\t\treturn queueTask;\n\t}\n\n\tfunction queueAnimationTask(callback: (...args: any[]) => any): Handle {\n\t\tconst item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\t\tconst rafId: number = requestAnimationFrame(executeTask.bind(null, item));\n\n\t\treturn getQueueHandle(item, function() {\n\t\t\tcancelAnimationFrame(rafId);\n\t\t});\n\t}\n\n\t// TODO: Use aspect.before when it is available.\n\treturn has('microtasks')\n\t\t? queueAnimationTask\n\t\t: function(callback: (...args: any[]) => any): Handle {\n\t\t\t\tcheckMicroTaskQueue();\n\t\t\t\treturn queueAnimationTask(callback);\n\t\t\t};\n})();\n\n/**\n * Schedules a callback to the microtask queue.\n *\n * Any callbacks registered with `queueMicroTask` will be executed before the next macrotask. If no native\n * mechanism for scheduling macrotasks is exposed, then any callbacks will be fired before any macrotask\n * registered with `queueTask` or `queueAnimationTask`.\n *\n * @param callback the function to be queued and later executed.\n * @returns An object with a `destroy` method that, when called, prevents the registered callback from executing.\n */\nexport let queueMicroTask = (function() {\n\tlet enqueue: (item: QueueItem) => void;\n\n\tif (has('host-node')) {\n\t\tenqueue = function(item: QueueItem): void {\n\t\t\tglobal.process.nextTick(executeTask.bind(null, item));\n\t\t};\n\t} else if (has('es6-promise')) {\n\t\tenqueue = function(item: QueueItem): void {\n\t\t\tglobal.Promise.resolve(item).then(executeTask);\n\t\t};\n\t} else if (has('dom-mutationobserver')) {\n\t\t/* tslint:disable-next-line:variable-name */\n\t\tconst HostMutationObserver = global.MutationObserver || global.WebKitMutationObserver;\n\t\tconst node = document.createElement('div');\n\t\tconst queue: QueueItem[] = [];\n\t\tconst observer = new HostMutationObserver(function(): void {\n\t\t\twhile (queue.length > 0) {\n\t\t\t\tconst item = queue.shift();\n\t\t\t\tif (item && item.isActive && item.callback) {\n\t\t\t\t\titem.callback();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tobserver.observe(node, { attributes: true });\n\n\t\tenqueue = function(item: QueueItem): void {\n\t\t\tqueue.push(item);\n\t\t\tnode.setAttribute('queueStatus', '1');\n\t\t};\n\t} else {\n\t\tenqueue = function(item: QueueItem): void {\n\t\t\tcheckMicroTaskQueue();\n\t\t\tmicroTasks.push(item);\n\t\t};\n\t}\n\n\treturn function(callback: (...args: any[]) => any): Handle {\n\t\tconst item: QueueItem = {\n\t\t\tisActive: true,\n\t\t\tcallback: callback\n\t\t};\n\n\t\tenqueue(item);\n\n\t\treturn getQueueHandle(item);\n\t};\n})();\n"]}